---
title: "Oklab"
---

<style>
    body {
        text-align: center;
    }

    canvas {
        max-width: 100%;
        max-height: 100vh;
    }
</style>

<script type="module">
    import {srgbToOklab, oklabToSrgb} from "./oklab.js";
    import * as transforms from "./transforms.js";

    const element = id => document.querySelector(`#${id}`);

    const picker = element("picker");
    const channel = element("channel");
    const nextPage = element("next-page");

    const canvas = element("canvas");
    const context = canvas.getContext("2d");

    let image;

    picker.addEventListener("change", async () => {
        try {
            await pickFile();
        } catch (error) {
            console.log(error);
            alert("Something really bad happened. Pretend you know what.");
        }
    });
    channel.addEventListener("change", redraw);

    async function pickFile() {
        const file = picker.files[0];

        if (!file) {
            return;
        }

        const element = await blobToImage(file);

        image = element;

        if (Math.random() < 0.1) {
            nextPage.hidden = false;
        }

        redraw();
    }

    function redraw() {
        if (!image) {
            return;
        }

        context.clearRect(0, 0, canvas.width, canvas.height);

        canvas.width = image.width;
        canvas.height = image.height;

        context.drawImage(image, 0, 0);

        process();
    }

    function process() {
        const transform = transforms[channel.value];

        const oldImage = context.getImageData(
            0, 0, image.width, image.height,
            {colorSpace: "srgb"}
        );

        const data = oldImage.data;

        const PIXEL_SIZE = 4;
        const RGB_SIZE = 3;

        for (let i = 0; i < data.length; i += PIXEL_SIZE) {
            const rgb = data.slice(i, i + RGB_SIZE);

            const processed = desaturate(rgb, transform);

            data.set(processed, i);
        }

        const newImage = new ImageData(data, image.width, image.height);

        context.putImageData(newImage, 0, 0);
    }

    function desaturate(pixel, transform) {
        const oklab = srgbToOklab(pixel);

        const desaturated = transform(oklab);

        const rgb = oklabToSrgb(desaturated);

        return rgb;
    }

    function blobToImage(blob) {
        return new Promise((resolve, reject) => {
            const image = new Image();
            const url = URL.createObjectURL(blob);

            image.onload = () => {
                URL.revokeObjectURL(url);

                return resolve(image)
            };
            image.onerror = error => {
                URL.revokeObjectURL(url);

                reject(error);
            }

            image.src = url;
        });
    }
</script>

<p><input id="picker" type="file" accept="image/*" autocomplete="off"></p>

<p>
    <select id="channel">
        <option value="L">L only</option>
        <option value="a">a only</option>
        <option value="b">b only</option>
        <option value="red">Redscale</option>
        <option value="green">Greenscale</option>
        <option value="blue">Bluescale</option>
        <option value="yellow">Yellowscale</option>
    </select>
</p>

<canvas id="canvas">There should be a canvas here.</canvas>

<p><a href="/9999-nine-nine-nine-nine/" id="next-page" hidden>Next page</a></p>
